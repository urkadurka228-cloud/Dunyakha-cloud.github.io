<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taxi Chaos - P2P –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: none;
            user-select: none;
        }

        body {
            background: #0a1929;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
        }

        /* –ú–µ–Ω—é */
        #menuOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 25, 41, 0.95) 0%, rgba(26, 26, 46, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .menuCard {
            background: rgba(0, 20, 40, 0.95);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 500px;
            border: 3px solid #00ff88;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .menuTitle {
            text-align: center;
            font-size: 2.2em;
            background: linear-gradient(45deg, #00ff88, #0077ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .menuSection {
            margin: 20px 0;
        }

        .inputField {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00ff88;
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
            outline: none;
        }

        .button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(45deg, #00ff88, #0077ff);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button:active {
            transform: scale(0.95);
        }

        .button.red {
            background: linear-gradient(45deg, #ff4444, #ff8800);
        }

        .button.green {
            background: linear-gradient(45deg, #00ff88, #00cc66);
        }

        .qrContainer {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        #qrCode {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }

        .roomCode {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 2em;
            text-align: center;
            letter-spacing: 5px;
            margin: 15px 0;
            border: 2px dashed #00ff88;
        }

        /* –ò–≥—Ä–æ–≤–æ–π UI */
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        .uiPanel {
            pointer-events: all;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #00ff88;
            backdrop-filter: blur(5px);
        }

        #topPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .playerInfo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #playerAvatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #00ff88, #0077ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        #scoreDisplay {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        #connectionInfo {
            position: absolute;
            top: 80px;
            right: 10px;
            font-size: 14px;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
        }

        /* –ú–∏–Ω–∏-–∫–∞—Ä—Ç–∞ */
        #miniMap {
            position: absolute;
            bottom: 120px;
            right: 10px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            border: 2px solid #00ff88;
            overflow: hidden;
        }

        #miniMapCanvas {
            width: 100%;
            height: 100%;
        }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: all;
        }

        .joystickArea {
            width: 120px;
            height: 120px;
            position: relative;
        }

        .joystickBase {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }

        .joystickHandle {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #00ff88, #0077ff);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid white;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            transition: transform 0.1s;
        }

        .actionButtons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .actionButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: transform 0.1s;
        }

        .actionButton:active {
            transform: scale(0.9);
        }

        #hornBtn { border-color: #ff9900; }
        #nitroBtn { border-color: #ff4444; }
        #brakeBtn { border-color: #4488ff; }

        /* –°–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ */
        #playersPanel {
            position: absolute;
            top: 80px;
            left: 10px;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
        }

        .playerCard {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 3px solid;
        }

        .playerAvatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 20px 30px;
            border-radius: 15px;
            border: 3px solid #00ff88;
            text-align: center;
            z-index: 1001;
            min-width: 250px;
            max-width: 90%;
            display: none;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .menuCard {
                padding: 20px;
            }
            
            .menuTitle {
                font-size: 1.8em;
            }
            
            .joystickArea {
                width: 100px;
                height: 100px;
            }
            
            .actionButton {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            #miniMap {
                width: 120px;
                height: 120px;
                bottom: 100px;
            }
        }

        @media (max-height: 700px) {
            #miniMap, #playersPanel {
                display: none;
            }
            
            .joystickArea {
                width: 90px;
                height: 90px;
            }
            
            .actionButton {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            #controls {
                bottom: 10px;
            }
        }
    </style>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è QR –∫–æ–¥–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>
    <!-- –ú–µ–Ω—é -->
    <div id="menuOverlay">
        <div class="menuCard">
            <h1 class="menuTitle">üöï TAXI CHAOS P2P üöï</h1>
            
            <div id="mainMenu">
                <div class="menuSection">
                    <h3 style="color: #00ff88; margin-bottom: 10px;">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
                    <input type="text" id="playerName" class="inputField" 
                           placeholder="–ò–º—è —Ç–∞–∫—Å–∏—Å—Ç–∞" value="–¢–∞–∫—Å–∏—Å—Ç" maxlength="12">
                    
                    <select id="carType" class="inputField">
                        <option value="taxi">üöï –ñ—ë–ª—Ç–æ–µ —Ç–∞–∫—Å–∏</option>
                        <option value="sport">üèéÔ∏è –°–ø–æ—Ä—Ç–∫–∞—Ä</option>
                        <option value="van">üöê –ú–∏–Ω–∏–≤—ç–Ω</option>
                        <option value="luxury">üíé –õ—é–∫—Å-—Å–µ–¥–∞–Ω</option>
                    </select>
                    
                    <select id="color" class="inputField">
                        <option value="#00ff88">–ó–µ–ª—ë–Ω—ã–π</option>
                        <option value="#ff4444">–ö—Ä–∞—Å–Ω—ã–π</option>
                        <option value="#4488ff">–°–∏–Ω–∏–π</option>
                        <option value="#ff9900">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
                        <option value="#aa44ff">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
                    </select>
                </div>
                
                <div class="menuSection">
                    <h3 style="color: #00ff88; margin-bottom: 10px;">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</h3>
                    <p style="color: #aaa; margin-bottom: 10px; font-size: 0.9em;">
                        –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π —á–µ—Ä–µ–∑ QR-–∫–æ–¥
                    </p>
                    <button id="createRoomBtn" class="button green">
                        üöï –°–û–ó–î–ê–¢–¨ –ö–û–ú–ù–ê–¢–£
                    </button>
                </div>
                
                <div class="menuSection">
                    <h3 style="color: #00ff88; margin-bottom: 10px;">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</h3>
                    <p style="color: #aaa; margin-bottom: 10px; font-size: 0.9em;">
                        –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã
                    </p>
                    
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="roomCodeInput" class="inputField" 
                               placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="6" style="flex: 1;">
                        <button id="joinRoomBtn" class="button" style="width: auto; padding: 15px 20px;">
                            –í–û–ô–¢–ò
                        </button>
                    </div>
                    
                    <div id="cameraContainer" style="margin-top: 10px; display: none;">
                        <video id="qrScanner" width="100%" style="border-radius: 10px;"></video>
                        <button id="stopScanBtn" class="button red" style="margin-top: 10px;">
                            ‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                        </button>
                    </div>
                    
                    <button id="startScanBtn" class="button" style="margin-top: 10px;">
                        üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR-–∫–æ–¥
                    </button>
                </div>
            </div>
            
            <div id="roomMenu" style="display: none;">
                <h3 style="color: #00ff88; text-align: center; margin-bottom: 20px;">
                    üéÆ –ö–æ–º–Ω–∞—Ç–∞ –∏–≥—Ä—ã
                </h3>
                
                <div class="roomCode" id="roomCodeDisplay">ABCD12</div>
                
                <div class="qrContainer">
                    <div id="qrCode"></div>
                    <p style="color: #aaa; margin-top: 10px;">
                        –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                    </p>
                </div>
                
                <div id="playersList">
                    <h4 style="color: #00ff88; margin-bottom: 10px;">–ò–≥—Ä–æ–∫–∏ –≤ –∫–æ–º–Ω–∞—Ç–µ:</h4>
                    <!-- –ò–≥—Ä–æ–∫–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="startGameBtn" class="button green" style="flex: 1;">
                        üèÅ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                    </button>
                    <button id="leaveRoomBtn" class="button red" style="width: auto; padding: 15px 20px;">
                        ‚ùå –í–´–ô–¢–ò
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–≥—Ä–∞ -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- –ò–≥—Ä–æ–≤–æ–π UI -->
    <div id="gameUI" style="display: none;">
        <div id="topPanel" class="uiPanel">
            <div class="playerInfo">
                <div id="playerAvatar">üöï</div>
                <div>
                    <div id="playerNameDisplay">–¢–∞–∫—Å–∏—Å—Ç</div>
                    <div id="moneyDisplay">$0</div>
                </div>
            </div>
            
            <div id="scoreDisplay">0 –æ—á–∫–æ–≤</div>
            
            <div id="gameTimer">10:00</div>
        </div>
        
        <div id="connectionInfo">
            <span id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: 1</span>
        </div>
        
        <div id="playersPanel" class="uiPanel">
            <h4 style="color: #00ff88; margin-bottom: 10px;">–ò–≥—Ä–æ–∫–∏ –æ–Ω–ª–∞–π–Ω</h4>
            <div id="onlinePlayers"></div>
        </div>
        
        <div id="miniMap" class="uiPanel">
            <canvas id="miniMapCanvas"></canvas>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <div id="controls">
            <div class="joystickArea">
                <div class="joystickBase"></div>
                <div class="joystickHandle" id="joystickHandle"></div>
            </div>
            
            <div class="actionButtons">
                <div class="actionButton" id="hornBtn">üì¢</div>
                <div class="actionButton" id="nitroBtn">‚ö°</div>
                <div class="actionButton" id="brakeBtn">üõë</div>
            </div>
        </div>
    </div>
    
    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification"></div>

    <script>
        // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
        const CONFIG = {
            CITY_SIZE: 3000,
            ROAD_WIDTH: 120,
            BLOCK_SIZE: 400,
            PLAYER_SIZE: 40,
            PLAYER_SPEED: 5,
            NITRO_MULTIPLIER: 2,
            NITRO_DURATION: 3000,
            GAME_TIME: 10 * 60 * 1000, // 10 –º–∏–Ω—É—Ç
            MAX_PLAYERS: 8,
            SIGNALING_SERVER: 'wss://signaling.simplewebrtc.com:443/'
        };

        // ========== –°–û–°–¢–û–Ø–ù–ò–ï –ò–ì–†–´ ==========
        let gameState = {
            phase: 'menu',
            isHost: false,
            roomCode: '',
            players: {},
            myId: null,
            city: null,
            
            player: {
                id: null,
                name: '–¢–∞–∫—Å–∏—Å—Ç',
                car: 'taxi',
                color: '#00ff88',
                x: 1500,
                y: 1500,
                rotation: 0,
                speed: 0,
                score: 0,
                money: 0,
                fuel: 100,
                missions: [],
                lastUpdate: Date.now()
            },
            
            // P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            connections: new Map(),
            dataChannel: null,
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            controls: { x: 0, y: 0 },
            abilities: {
                nitro: { active: false, endTime: 0 }
            },
            
            // –í—Ä–µ–º—è
            gameTime: CONFIG.GAME_TIME,
            gameStartTime: 0
        };

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        function init() {
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas
            const canvas = document.getElementById('gameCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ—Ä–æ–¥–∞
            generateCity();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            setupElements();
            setupControls();
            
            // –ù–∞—á–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫
            gameState.myId = generatePlayerId();
            gameState.player.id = gameState.myId;
            gameState.players[gameState.myId] = { ...gameState.player };
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            gameLoop();
            
            console.log('–ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞. ID –∏–≥—Ä–æ–∫–∞:', gameState.myId);
        }

        function generatePlayerId() {
            return 'player_' + Math.random().toString(36).substr(2, 9);
        }

        function generateCity() {
            gameState.city = {
                roads: [],
                buildings: [],
                passengers: []
            };
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ—Ä–æ–≥
            for (let x = 0; x <= CONFIG.CITY_SIZE; x += CONFIG.BLOCK_SIZE) {
                gameState.city.roads.push({
                    x1: x, y1: 0,
                    x2: x, y2: CONFIG.CITY_SIZE,
                    width: CONFIG.ROAD_WIDTH,
                    isVertical: true
                });
            }
            
            for (let y = 0; y <= CONFIG.CITY_SIZE; y += CONFIG.BLOCK_SIZE) {
                gameState.city.roads.push({
                    x1: 0, y1: y,
                    x2: CONFIG.CITY_SIZE, y2: y,
                    width: CONFIG.ROAD_WIDTH,
                    isVertical: false
                });
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–¥–∞–Ω–∏–π
            for (let i = 0; i < 50; i++) {
                gameState.city.buildings.push({
                    x: Math.random() * CONFIG.CITY_SIZE,
                    y: Math.random() * CONFIG.CITY_SIZE,
                    width: 60 + Math.random() * 80,
                    height: 80 + Math.random() * 120,
                    color: `hsl(${Math.random() * 360}, 70%, 40%)`
                });
            }
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
            for (let i = 0; i < 15; i++) {
                gameState.city.passengers.push({
                    id: 'p' + i,
                    x: Math.random() * CONFIG.CITY_SIZE,
                    y: Math.random() * CONFIG.CITY_SIZE,
                    type: ['üë®', 'üë©', 'üë¥', 'üëÆ', 'üë∑'][Math.floor(Math.random() * 5)],
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    waiting: true
                });
            }
        }

        function setupElements() {
            // –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('createRoomBtn').addEventListener('click', createRoom);
            document.getElementById('joinRoomBtn').addEventListener('click', joinRoom);
            document.getElementById('startScanBtn').addEventListener('click', startQRScan);
            document.getElementById('stopScanBtn').addEventListener('click', stopQRScan);
            
            // –ú–µ–Ω—é –∫–æ–º–Ω–∞—Ç—ã
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('leaveRoomBtn').addEventListener('click', leaveRoom);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('playerName').addEventListener('input', updatePlayerProfile);
            document.getElementById('carType').addEventListener('change', updatePlayerProfile);
            document.getElementById('color').addEventListener('change', updatePlayerProfile);
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å
            window.addEventListener('resize', () => {
                const canvas = document.getElementById('gameCanvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }

        function updatePlayerProfile() {
            gameState.player.name = document.getElementById('playerName').value || '–¢–∞–∫—Å–∏—Å—Ç';
            gameState.player.car = document.getElementById('carType').value;
            gameState.player.color = document.getElementById('color').value;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatars = {
                taxi: 'üöï',
                sport: 'üèéÔ∏è',
                van: 'üöê',
                luxury: 'üíé'
            };
            document.getElementById('playerAvatar').textContent = avatars[gameState.player.car] || 'üöó';
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
            if (gameState.phase === 'playing' || gameState.phase === 'room') {
                broadcastPlayerUpdate();
            }
        }

        // ========== P2P –ú–£–õ–¨–¢–ò–ü–õ–ï–ï–† ==========
        function createRoom() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∫–æ–º–Ω–∞—Ç—ã
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            
            gameState.roomCode = code;
            gameState.isHost = true;
            gameState.phase = 'room';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            updatePlayerProfile();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∫–æ–º–Ω–∞—Ç—ã
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('roomMenu').style.display = 'block';
            document.getElementById('roomCodeDisplay').textContent = code;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
            const qrData = JSON.stringify({
                type: 'join',
                roomCode: code,
                game: 'TaxiChaos',
                timestamp: Date.now()
            });
            
            QRCode.toCanvas(document.getElementById('qrCode'), qrData, {
                width: 200,
                margin: 1,
                color: {
                    dark: '#00ff88',
                    light: '#00000000'
                }
            }, function(error) {
                if (error) console.error('QR code error:', error);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–±—è –≤ —Å–ø–∏—Å–æ–∫
            updatePlayersList();
            
            showNotification(`–ö–æ–º–Ω–∞—Ç–∞ "${code}" —Å–æ–∑–¥–∞–Ω–∞!`, 'success');
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Å–ª—É—à–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ WebRTC
            startPeerConnection();
        }

        function joinRoom() {
            const code = document.getElementById('roomCodeInput').value.toUpperCase().trim();
            
            if (!code || code.length !== 6) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã', 'error');
                return;
            }
            
            gameState.roomCode = code;
            gameState.isHost = false;
            gameState.phase = 'room';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å
            updatePlayerProfile();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é –∫–æ–º–Ω–∞—Ç—ã
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('roomMenu').style.display = 'block';
            document.getElementById('roomCodeDisplay').textContent = code;
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ö–æ—Å—Ç—É
            connectToHost(code);
            
            showNotification(`–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ "${code}"...`, 'info');
        }

        function startPeerConnection() {
            // –ü—Ä–æ—Å—Ç–∞—è P2P —Å–∏—Å—Ç–µ–º–∞ —á–µ—Ä–µ–∑ WebRTC DataChannel
            try {
                // –°–æ–∑–¥–∞–µ–º peer connection
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' }
                    ]
                });
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö
                const dataChannel = pc.createDataChannel('taxi-game');
                setupDataChannel(dataChannel);
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º offer
                pc.createOffer()
                    .then(offer => pc.setLocalDescription(offer))
                    .then(() => {
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å offer –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
                        // —á–µ—Ä–µ–∑ signaling —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ QR-–∫–æ–¥
                        console.log('Peer connection –≥–æ—Ç–æ–≤');
                    })
                    .catch(console.error);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
                        console.log('New ICE candidate:', event.candidate);
                    }
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                gameState.peerConnection = pc;
                gameState.dataChannel = dataChannel;
                
            } catch (error) {
                console.error('WebRTC error:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebRTC. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã.', 'error');
            }
        }

        function setupDataChannel(channel) {
            channel.onopen = () => {
                console.log('Data channel –æ—Ç–∫—Ä—ã—Ç');
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –¥—Ä—É–≥–æ–º—É –∏–≥—Ä–æ–∫—É!', 'success');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                sendToDataChannel({
                    type: 'playerJoin',
                    player: gameState.player
                });
            };
            
            channel.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleNetworkMessage(data);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
            };
            
            channel.onclose = () => {
                console.log('Data channel –∑–∞–∫—Ä—ã—Ç');
                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ', 'warning');
            };
        }

        function sendToDataChannel(data) {
            if (gameState.dataChannel && gameState.dataChannel.readyState === 'open') {
                gameState.dataChannel.send(JSON.stringify(data));
            }
        }

        function handleNetworkMessage(data) {
            switch(data.type) {
                case 'playerJoin':
                    // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
                    addRemotePlayer(data.player);
                    break;
                    
                case 'playerUpdate':
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
                    updateRemotePlayer(data);
                    break;
                    
                case 'gameStart':
                    // –ù–∞—á–∞–ª–æ –∏–≥—Ä—ã
                    startGameClient(data);
                    break;
                    
                case 'playerLeave':
                    // –ò–≥—Ä–æ–∫ –≤—ã—à–µ–ª
                    removeRemotePlayer(data.playerId);
                    break;
                    
                case 'chat':
                    // –°–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
                    showNotification(`${data.playerName}: ${data.message}`, 'info');
                    break;
            }
        }

        function addRemotePlayer(playerData) {
            if (!gameState.players[playerData.id]) {
                gameState.players[playerData.id] = playerData;
                updatePlayersList();
                showNotification(`${playerData.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ!`, 'success');
            }
        }

        function updateRemotePlayer(data) {
            const player = gameState.players[data.playerId];
            if (player && data.playerId !== gameState.myId) {
                Object.assign(player, data);
                player.lastUpdate = Date.now();
            }
        }

        function removeRemotePlayer(playerId) {
            if (gameState.players[playerId]) {
                const name = gameState.players[playerId].name;
                delete gameState.players[playerId];
                updatePlayersList();
                showNotification(`${name} –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É`, 'warning');
            }
        }

        function broadcastPlayerUpdate() {
            sendToDataChannel({
                type: 'playerUpdate',
                playerId: gameState.myId,
                ...gameState.player
            });
        }

        function connectToHost(roomCode) {
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebRTC
            // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            setTimeout(() => {
                addRemotePlayer({
                    id: 'host_' + roomCode,
                    name: '–•–æ—Å—Ç',
                    car: 'taxi',
                    color: '#ff4444',
                    x: 1600,
                    y: 1600,
                    score: 0
                });
                
                showNotification('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ö–æ—Å—Ç—É!', 'success');
            }, 1000);
        }

        // ========== QR –°–ö–ê–ù–ï–† ==========
        function startQRScan() {
            if (!('BarcodeDetector' in window)) {
                showNotification('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–æ–≤', 'error');
                return;
            }
            
            document.getElementById('cameraContainer').style.display = 'block';
            document.getElementById('startScanBtn').style.display = 'none';
            
            const video = document.getElementById('qrScanner');
            const barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                video.play();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                function scanQR() {
                    barcodeDetector.detect(video)
                        .then(barcodes => {
                            if (barcodes.length > 0) {
                                const qrData = barcodes[0].rawValue;
                                try {
                                    const data = JSON.parse(qrData);
                                    if (data.type === 'join' && data.game === 'TaxiChaos') {
                                        document.getElementById('roomCodeInput').value = data.roomCode;
                                        stopQRScan();
                                        showNotification('QR-–∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω!', 'success');
                                    }
                                } catch (error) {
                                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ QR:', error);
                                }
                            }
                            requestAnimationFrame(scanQR);
                        })
                        .catch(console.error);
                }
                
                scanQR();
            })
            .catch(error => {
                console.error('Camera error:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ', 'error');
                stopQRScan();
            });
        }

        function stopQRScan() {
            const video = document.getElementById('qrScanner');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
        }

        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï ==========
        function setupControls() {
            const joystick = document.getElementById('joystickHandle');
            const base = document.querySelector('.joystickBase');
            let isDragging = false;
            
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDragging = true;
            });
            
            document.addEventListener('touchmove', (e) => {
                if (!isDragging || gameState.phase !== 'playing') return;
                e.preventDefault();
                
                const touch = e.touches[0];
                const baseRect = base.getBoundingClientRect();
                const centerX = baseRect.left + baseRect.width / 2;
                const centerY = baseRect.top + baseRect.height / 2;
                
                let deltaX = touch.clientX - centerX;
                let deltaY = touch.clientY - centerY;
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ
                const maxMove = baseRect.width / 2 - 25;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > maxMove) {
                    deltaX = (deltaX / distance) * maxMove;
                    deltaY = (deltaY / distance) * maxMove;
                }
                
                // –ü–æ–∑–∏—Ü–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
                joystick.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ)
                gameState.controls.x = deltaX / maxMove;
                gameState.controls.y = deltaY / maxMove;
            });
            
            document.addEventListener('touchend', () => {
                if (!isDragging) return;
                
                isDragging = false;
                joystick.style.transform = 'translate(-50%, -50%)';
                gameState.controls.x = 0;
                gameState.controls.y = 0;
            });
            
            // –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
            document.getElementById('hornBtn').addEventListener('click', useHorn);
            document.getElementById('nitroBtn').addEventListener('click', useNitro);
            document.getElementById('brakeBtn').addEventListener('click', useBrake);
            
            // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            window.addEventListener('keydown', (e) => {
                if (gameState.phase !== 'playing') return;
                
                switch(e.key) {
                    case 'ArrowUp': case 'w': gameState.controls.y = -1; break;
                    case 'ArrowDown': case 's': gameState.controls.y = 1; break;
                    case 'ArrowLeft': case 'a': gameState.controls.x = -1; break;
                    case 'ArrowRight': case 'd': gameState.controls.x = 1; break;
                    case ' ': useHorn(); break;
                    case 'Shift': useNitro(); break;
                }
            });
            
            window.addEventListener('keyup', () => {
                gameState.controls.x = 0;
                gameState.controls.y = 0;
            });
        }

        function useHorn() {
            if (gameState.phase !== 'playing') return;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–≤—É–∫ –≥—É–¥–∫–∞ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
            sendToDataChannel({
                type: 'chat',
                playerId: gameState.myId,
                playerName: gameState.player.name,
                message: 'üì¢ –ë–∏-–±–∏–ø!'
            });
            
            showNotification('üì¢ –ë–∏-–±–∏–ø!', 'info');
        }

        function useNitro() {
            if (gameState.phase !== 'playing') return;
            
            gameState.abilities.nitro.active = true;
            gameState.abilities.nitro.endTime = Date.now() + CONFIG.NITRO_DURATION;
            
            showNotification('‚ö° –ù–ò–¢–†–û –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–û!', 'success');
        }

        function useBrake() {
            if (gameState.phase !== 'playing') return;
            
            gameState.player.speed = 0;
            showNotification('üõë –¢–æ—Ä–º–æ–∂–µ–Ω–∏–µ!', 'info');
        }

        // ========== –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ==========
        function updateGame() {
            if (gameState.phase !== 'playing') return;
            
            const now = Date.now();
            const deltaTime = now - gameState.player.lastUpdate;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
            if (gameState.gameStartTime) {
                const elapsed = now - gameState.gameStartTime;
                gameState.gameTime = CONFIG.GAME_TIME - elapsed;
                
                if (gameState.gameTime <= 0) {
                    endGame();
                    return;
                }
                
                updateTimer();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            updatePlayer(deltaTime);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤
            updateRemotePlayers(now);
            
            gameState.player.lastUpdate = now;
        }

        function updatePlayer(deltaTime) {
            const player = gameState.player;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            let speed = CONFIG.PLAYER_SPEED;
            if (gameState.abilities.nitro.active && Date.now() < gameState.abilities.nitro.endTime) {
                speed *= CONFIG.NITRO_MULTIPLIER;
            } else {
                gameState.abilities.nitro.active = false;
            }
            
            // –î–≤–∏–∂–µ–Ω–∏–µ
            if (Math.abs(gameState.controls.x) > 0.1 || Math.abs(gameState.controls.y) > 0.1) {
                player.x += gameState.controls.x * speed;
                player.y += gameState.controls.y * speed;
                
                // –ü–æ–≤–æ—Ä–æ—Ç
                if (Math.abs(gameState.controls.x) > 0.1) {
                    player.rotation = Math.atan2(gameState.controls.y, gameState.controls.x);
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –≥–æ—Ä–æ–¥–∞
                player.x = Math.max(0, Math.min(CONFIG.CITY_SIZE, player.x));
                player.y = Math.max(0, Math.min(CONFIG.CITY_SIZE, player.y));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–∞–º
                broadcastPlayerUpdate();
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–±–æ—Ä–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤
            checkPassengerPickup();
        }

        function updateRemotePlayers(now) {
            // –£–¥–∞–ª—è–µ–º –∏–≥—Ä–æ–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞–≤–Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å
            Object.keys(gameState.players).forEach(playerId => {
                if (playerId !== gameState.myId) {
                    const player = gameState.players[playerId];
                    if (now - player.lastUpdate > 10000) { // 10 —Å–µ–∫—É–Ω–¥
                        removeRemotePlayer(playerId);
                    }
                }
            });
        }

        function checkPassengerPickup() {
            const player = gameState.player;
            
            gameState.city.passengers.forEach((passenger, index) => {
                if (passenger.waiting) {
                    const dx = player.x - passenger.x;
                    const dy = player.y - passenger.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < 50) {
                        // –ü–æ–¥–±–∏—Ä–∞–µ–º –ø–∞—Å—Å–∞–∂–∏—Ä–∞
                        passenger.waiting = false;
                        player.score += 100;
                        player.money += 50;
                        
                        showNotification(`‚úÖ –ü–æ–¥–æ–±—Ä–∞–ª–∏ –ø–∞—Å—Å–∞–∂–∏—Ä–∞! +$50`, 'success');
                        updateUI();
                        
                        // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä
                        setTimeout(() => {
                            passenger.x = Math.random() * CONFIG.CITY_SIZE;
                            passenger.y = Math.random() * CONFIG.CITY_SIZE;
                            passenger.waiting = true;
                        }, 10000);
                    }
                }
            });
        }

        // ========== –ò–ì–†–û–í–´–ï –°–û–ë–´–¢–ò–Ø ==========
        function startGame() {
            if (!gameState.isHost) return;
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã –≤—Å–µ–º
            sendToDataChannel({
                type: 'gameStart',
                gameTime: CONFIG.GAME_TIME,
                timestamp: Date.now()
            });
            
            startGameClient();
        }

        function startGameClient(data) {
            gameState.phase = 'playing';
            gameState.gameStartTime = data?.timestamp || Date.now();
            gameState.gameTime = CONFIG.GAME_TIME;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
            document.getElementById('menuOverlay').style.display = 'none';
            document.getElementById('gameUI').style.display = 'block';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ –≤ –∏–≥—Ä–µ
            updateOnlinePlayers();
            
            showNotification('üèÅ –ò–ì–†–ê –ù–ê–ß–ê–õ–ê–°–¨! –£–¥–∞—á–∏ –Ω–∞ –¥–æ—Ä–æ–≥–∞—Ö!', 'success');
        }

        function leaveRoom() {
            if (gameState.phase === 'playing') {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≤—ã—Ö–æ–¥–µ
                sendToDataChannel({
                    type: 'playerLeave',
                    playerId: gameState.myId
                });
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            gameState.phase = 'menu';
            gameState.isHost = false;
            gameState.roomCode = '';
            gameState.connections.clear();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            document.getElementById('roomMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
            document.getElementById('gameUI').style.display = 'none';
            document.getElementById('menuOverlay').style.display = 'flex';
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤
            gameState.players = {};
            gameState.players[gameState.myId] = { ...gameState.player };
        }

        function endGame() {
            gameState.phase = 'menu';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const results = `
                <div style="text-align: center; padding: 20px;">
                    <h2 style="color: #ffd700; margin-bottom: 20px;">üèÅ –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê! üèÅ</h2>
                    <div style="font-size: 24px; color: #00ff88; margin: 20px 0;">
                        –í–∞—à —Å—á—ë—Ç: ${gameState.player.score}
                    </div>
                    <div style="font-size: 20px; color: #ff9900; margin: 10px 0;">
                        –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: $${gameState.player.money}
                    </div>
                </div>
            `;
            
            showNotification(results, 'success');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –º–µ–Ω—é —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                leaveRoom();
            }, 5000);
        }

        // ========== –û–¢–†–ò–°–û–í–ö–ê ==========
        function renderGame() {
            if (gameState.phase !== 'playing') return;
            
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
            const cameraX = gameState.player.x - canvas.width / 2;
            const cameraY = gameState.player.y - canvas.height / 2;
            
            ctx.save();
            ctx.translate(-cameraX, -cameraY);
            
            // –†–∏—Å—É–µ–º –≥–æ—Ä–æ–¥
            renderCity(ctx);
            
            // –†–∏—Å—É–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
            Object.values(gameState.players).forEach(player => {
                renderPlayer(ctx, player);
            });
            
            ctx.restore();
            
            // –†–∏—Å—É–µ–º –º–∏–Ω–∏-–∫–∞—Ä—Ç—É
            renderMiniMap();
        }

        function renderCity(ctx) {
            if (!gameState.city) return;
            
            // –î–æ—Ä–æ–≥–∏
            ctx.strokeStyle = '#333';
            ctx.lineWidth = CONFIG.ROAD_WIDTH;
            ctx.lineCap = 'square';
            
            gameState.city.roads.forEach(road => {
                ctx.beginPath();
                ctx.moveTo(road.x1, road.y1);
                ctx.lineTo(road.x2, road.y2);
                ctx.stroke();
            });
            
            // –†–∞–∑–º–µ—Ç–∫–∞
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 4;
            ctx.setLineDash([30, 20]);
            
            gameState.city.roads.forEach(road => {
                ctx.beginPath();
                ctx.moveTo(road.x1, road.y1);
                ctx.lineTo(road.x2, road.y2);
                ctx.stroke();
            });
            
            ctx.setLineDash([]);
            
            // –ó–¥–∞–Ω–∏—è
            gameState.city.buildings.forEach(building => {
                ctx.fillStyle = building.color;
                ctx.fillRect(building.x, building.y, building.width, building.height);
                
                // –û–∫–Ω–∞
                ctx.fillStyle = '#ffffaa';
                for (let wx = 5; wx < building.width; wx += 15) {
                    for (let wy = 5; wy < building.height; wy += 15) {
                        if (Math.random() > 0.4) {
                            ctx.fillRect(building.x + wx, building.y + wy, 8, 8);
                        }
                    }
                }
            });
            
            // –ü–∞—Å—Å–∞–∂–∏—Ä—ã
            gameState.city.passengers.forEach(passenger => {
                if (passenger.waiting) {
                    // –ê–Ω–∏–º–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
                    const bounce = Math.sin(Date.now() / 500) * 5;
                    
                    ctx.fillStyle = passenger.color;
                    ctx.beginPath();
                    ctx.arc(passenger.x, passenger.y + bounce, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –ò–∫–æ–Ω–∫–∞
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(passenger.type, passenger.x, passenger.y + bounce);
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(passenger.x, passenger.y + bounce, 20, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }

        function renderPlayer(ctx, player) {
            const isMe = player.id === gameState.myId;
            
            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.rotation);
            
            // –ö—É–∑–æ–≤ –º–∞—à–∏–Ω—ã
            ctx.fillStyle = player.color;
            ctx.fillRect(
                -CONFIG.PLAYER_SIZE / 2,
                -CONFIG.PLAYER_SIZE / 3,
                CONFIG.PLAYER_SIZE,
                CONFIG.PLAYER_SIZE / 1.5
            );
            
            // –û–∫–Ω–∞
            ctx.fillStyle = '#aaddff';
            ctx.fillRect(-15, -12, 30, 10);
            
            // –§–∞—Ä—ã
            ctx.fillStyle = '#ffff88';
            ctx.fillRect(-CONFIG.PLAYER_SIZE / 2 - 5, -8, 5, 6);
            ctx.fillRect(-CONFIG.PLAYER_SIZE / 2 - 5, 2, 5, 6);
            ctx.fillRect(CONFIG.PLAYER_SIZE / 2, -8, 5, 6);
            ctx.fillRect(CONFIG.PLAYER_SIZE / 2, 2, 5, 6);
            
            // –¢–∞–∫—Å–∏-—à–∞—à–µ—á–∫–∏
            if (player.car === 'taxi') {
                ctx.fillStyle = '#000';
                for (let i = -3; i <= 3; i++) {
                    ctx.fillRect(i * 10 - 4, -18, 8, 8);
                }
            }
            
            // –ò–∫–æ–Ω–∫–∞ –º–∞—à–∏–Ω—ã
            const icons = {
                taxi: 'üöï',
                sport: 'üèéÔ∏è',
                van: 'üöê',
                luxury: 'üíé'
            };
            
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(icons[player.car] || 'üöó', 0, 0);
            
            ctx.restore();
            
            // –ò–º—è –∏–≥—Ä–æ–∫–∞
            ctx.fillStyle = isMe ? '#00ff88' : '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(player.name, player.x, player.y - 30);
            
            // –°—á–µ—Ç
            ctx.font = '12px Arial';
            ctx.fillText(`$${player.score}`, player.x, player.y - 45);
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            if (isMe) {
                ctx.strokeStyle = '#00ff88';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x, player.y, CONFIG.PLAYER_SIZE + 10, 0, Math.PI * 2);
                ctx.stroke();
            }
        }

        function renderMiniMap() {
            const canvas = document.getElementById('miniMapCanvas');
            const ctx = canvas.getContext('2d');
            
            if (!canvas.width) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            
            // –û—á–∏—Å—Ç–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –§–æ–Ω
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ú–∞—Å—à—Ç–∞–±
            const scale = Math.min(canvas.width / CONFIG.CITY_SIZE, canvas.height / CONFIG.CITY_SIZE);
            
            // –î–æ—Ä–æ–≥–∏
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            gameState.city.roads.forEach(road => {
                ctx.beginPath();
                ctx.moveTo(road.x1 * scale, road.y1 * scale);
                ctx.lineTo(road.x2 * scale, road.y2 * scale);
                ctx.stroke();
            });
            
            // –ò–≥—Ä–æ–∫–∏
            Object.values(gameState.players).forEach(player => {
                const isMe = player.id === gameState.myId;
                
                ctx.fillStyle = isMe ? '#00ff88' : player.color;
                ctx.beginPath();
                ctx.arc(player.x * scale, player.y * scale, 4, 0, Math.PI * 2);
                ctx.fill();
                
                // –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                if (isMe) {
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(player.x * scale, player.y * scale);
                    ctx.lineTo(
                        (player.x + Math.cos(player.rotation) * 15) * scale,
                        (player.y + Math.sin(player.rotation) * 15) * scale
                    );
                    ctx.stroke();
                }
            });
            
            // –ü–∞—Å—Å–∞–∂–∏—Ä—ã
            ctx.fillStyle = '#00ff00';
            gameState.city.passengers.forEach(passenger => {
                if (passenger.waiting) {
                    ctx.beginPath();
                    ctx.arc(passenger.x * scale, passenger.y * scale, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
        }

        // ========== UI –§–£–ù–ö–¶–ò–ò ==========
        function updateUI() {
            const player = gameState.player;
            
            // –ò–º—è –∏ –¥–µ–Ω—å–≥–∏
            document.getElementById('playerNameDisplay').textContent = player.name;
            document.getElementById('moneyDisplay').textContent = `$${player.money}`;
            
            // –°—á–µ—Ç
            document.getElementById('scoreDisplay').textContent = `${player.score} –æ—á–∫–æ–≤`;
            
            // –ê–≤–∞—Ç–∞—Ä
            const avatars = {
                taxi: 'üöï',
                sport: 'üèéÔ∏è',
                van: 'üöê',
                luxury: 'üíé'
            };
            document.getElementById('playerAvatar').textContent = avatars[player.car] || 'üöó';
            document.getElementById('playerAvatar').style.background = `linear-gradient(45deg, ${player.color}, #0077ff)`;
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
            const onlineCount = Object.keys(gameState.players).length;
            document.getElementById('connectionStatus').textContent = `–ò–≥—Ä–æ–∫–æ–≤: ${onlineCount}`;
        }

        function updateTimer() {
            const minutes = Math.floor(gameState.gameTime / 60000);
            const seconds = Math.floor((gameState.gameTime % 60000) / 1000);
            document.getElementById('gameTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            if (!container) return;
            
            let html = '<div style="max-height: 200px; overflow-y: auto;">';
            
            Object.values(gameState.players).forEach(player => {
                const isMe = player.id === gameState.myId;
                html += `
                    <div class="playerCard" style="border-left-color: ${player.color}">
                        <div class="playerAvatar" style="background: ${player.color}">
                            ${player.car === 'taxi' ? 'üöï' : player.car === 'sport' ? 'üèéÔ∏è' : player.car === 'van' ? 'üöê' : 'üíé'}
                        </div>
                        <div>
                            <div style="font-weight: bold;">${player.name}</div>
                            <div style="font-size: 0.9em; color: #aaa;">$${player.score}</div>
                        </div>
                        ${isMe ? '<div style="color: #00ff88; font-size: 0.8em;">(–í—ã)</div>' : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function updateOnlinePlayers() {
            const container = document.getElementById('onlinePlayers');
            if (!container) return;
            
            let html = '';
            
            Object.values(gameState.players).forEach(player => {
                const isMe = player.id === gameState.myId;
                html += `
                    <div class="playerCard" style="border-left-color: ${player.color}">
                        <div class="playerAvatar" style="background: ${player.color}">
                            ${player.car === 'taxi' ? 'üöï' : player.car === 'sport' ? 'üèéÔ∏è' : player.car === 'van' ? 'üöê' : 'üíé'}
                        </div>
                        <div>
                            <div style="font-weight: bold;">${player.name}</div>
                            <div style="font-size: 0.9em; color: #aaa;">$${player.score}</div>
                        </div>
                        ${isMe ? '<div style="color: #00ff88;">‚ñ∂</div>' : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.innerHTML = message;
            notification.style.display = 'block';
            
            const colors = {
                info: '#00ff88',
                success: '#00ff88',
                error: '#ff4444',
                warning: '#ff9900'
            };
            
            notification.style.borderColor = colors[type] || colors.info;
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ
            if (type !== 'error') {
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // ========== –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ==========
        function gameLoop() {
            updateGame();
            renderGame();
            requestAnimationFrame(gameLoop);
        }

        // ========== –ó–ê–ü–£–°–ö ==========
        window.onload = init;
    </script>
</body>
</html>
